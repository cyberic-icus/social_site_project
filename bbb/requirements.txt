from django.db import models
from tinymce import HTMLField
from django.urls import reverse

from django.contrib.auth import get_user_model

User = get_user_model()
		
class Comment(models.Model):
	author = models.ForeignKey(User, on_delete=models.CASCADE)
	post = models.ForeignKey(Article, on_delete=models.CASCADE)
	content = models.TextField(null=False)
	pub_date = models.DateTimeField('Date Published', auto_now_add=True)
	
	class Meta:
		ordering = ['pub_date']
	
	def get_absolute_url(self):
		return reverse('comments:comment-detail', kwargs={'id':self.id})
	
	def __str__(self):
		return f'{self.author.username}\'s Comment'
=================================================

from django import forms
from .models import Comment
	

class CommentModelForm(forms.ModelForm):
	class Meta:
		model = Comment
		fields = [
			'content'
			]
=================================================
from django.urls import path
from .views import (
	CommentListView,
	CommentDetailView,
	CommentCreateView,
	CommentUpdateView,
	CommentDeleteView,
	
)
app_name = 'comments'

urlpatterns = [
    path('', CommentListView.as_view(), name='comment-list'),
    path('<int:id>', CommentDetailView.as_view(), name='comment-detail'),
    path('create/', CommentCreateView.as_view(), name='comment-create'),
    path('update/', CommentUpdateView.as_view(), name='comment-update'),
    path('delete/', CommentDeleteView.as_view(), name='comment-delete'),
    
]
=================================================
from django.shortcuts import render, get_object_or_404
from django.views.generic import CreateView,DetailView,ListView,UpdateView,DeleteView
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.urls import reverse_lazy

from .models import Article, Comment
from .forms import ArticleModelForm, CommentModelForm


"""
1. Дополнить документацию представлений.
2. Сделать нормальное наследование.

"""

	
class CommentListView(LoginRequiredMixin, ListView):
	"""Представление списка статей. НА УДАЛЕНИЕ!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! """
	template_name = 'articles/comment_list.html'
	model = Comment


class CommentDetailView(LoginRequiredMixin, DetailView):
	"""Представление конкретной статьи."""
	template_name = 'articles/comment_detail.html'
	
	def get_object(self):
		id_ = self.kwargs.get('id')
		return get_object_or_404(Comment, id = id_)
	
class CommentCreateView(LoginRequiredMixin, CreateView):
	"""Представление создания статьи."""
	template_name = 'articles/comment_create.html'
	model = Comment
	fields = ['content',]
	
	def get_object(self):
		id_ = self.kwargs.get('id')
		return get_object_or_404(Article, id = id_)
	
	def get_success_url(self):
		pk_ = self.get_object_comment().id
		return reverse_lazy('articles:comment-single', kwargs={'pk':pk_})
	
	def form_valid(self, form):
		form.instance.author = self.request.user
		form.instance.post = self.get_object()
		return super().form_valid(form)
	
class CommentUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
	"""Представление изменения существующей статьи."""
	template_name = 'articles/comment_create.html'
	model = Comment
	form_class = CommentModelForm
	
	
	def get_object(self):
		id_ = self.kwargs.get('id')
		return get_object_or_404(Article, id = id_)
	
	def form_valid(self, form):
		form.instance.author = self.request.user
		return super().form_valid(form)
		
	def test_func(self):
		post = self.get_object()
		if self.request.user == post.author:
			return True
		return False

class CommentDeleteView(LoginRequiredMixin, UserPassesTestMixin,  DeleteView):
	"""Представление удаления конкретной статьи."""
	template_name = 'articles/comment_delete.html'
	model = Comment
	form_class = CommentModelForm
	
	def get_success_url(self):
		username_ = self.request.user.username
		return reverse_lazy('users:users-single', kwargs={'username':username_})
		
		
	def get_object(self):
		id_ = self.kwargs.get('id')
		return get_object_or_404(Article, id = id_)
	
		
	def test_func(self):
		post = self.get_object()
		if self.request.user == post.author:
			return True
		return False	

=================================================
